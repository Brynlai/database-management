-- =================================
-- QUERY 1: MEMBER BOOKING HISTORY
-- =================================

SET LINESIZE 150
SET PAGESIZE 50
TTITLE CENTER 'Booking and Ticket History' SKIP 3

COLUMN booking_date       FORMAT A15        HEADING 'Booking Date'
COLUMN origin_station     FORMAT A20        HEADING 'Origin'
COLUMN destination_station FORMAT A20       HEADING 'Destination'
COLUMN departure_time     FORMAT A22        HEADING 'Departure'
COLUMN seat_number        FORMAT A8         HEADING 'Seat'
COLUMN ticket_status      FORMAT A10        HEADING 'Status'
COLUMN base_price         FORMAT 9,990.00   HEADING 'Price (RM)'
COLUMN company_name       FORMAT A35        HEADING 'Bus Company'

BREAK ON booking_date SKIP 1
COMPUTE SUM LABEL 'Subtotal:' OF base_price ON booking_date

SELECT
    TO_CHAR(booking_date, 'DD-Mon-YYYY') AS booking_date,
    origin_station,
    destination_station,
    TO_CHAR(departure_time, 'DD-Mon-YYYY HH:MI AM') AS departure_time,
    seat_number,
    ticket_status,
    base_price,
    company_name
FROM V_BOOKING_DETAILS
WHERE LOWER(TRIM(member_email)) = LOWER(TRIM('&enter_member_email'))
ORDER BY booking_date DESC, departure_time ASC;

TTITLE OFF;
BTITLE OFF;
CLEAR COLUMNS;
CLEAR BREAKS;
CLEAR COMPUTES;

-- =================================
-- QUERY 2: BUS SCHEDULE SEARCH
-- =================================

SET LINESIZE 150
SET PAGESIZE 50
TTITLE CENTER 'Available Bus Schedules' SKIP 2
BTITLE OFF

COLUMN departure_time     FORMAT A20        HEADING 'Departure'
COLUMN arrival_time       FORMAT A20        HEADING 'Arrival'
COLUMN company_name       FORMAT A25        HEADING 'Bus Company'
COLUMN base_price         FORMAT 9,990.00   HEADING 'Price (RM)'
COLUMN available_seats    FORMAT 990        HEADING 'Seats Left'
COLUMN platform_no        FORMAT A10        HEADING 'Platform'
COLUMN booked_seats       FORMAT A30        HEADING 'Booked Seats' WORD_WRAPPED

SELECT
    vbsd.schedule_id,
    TO_CHAR(vbsd.departure_time, 'DD-Mon-YYYY HH:MI AM') AS departure_time,
    TO_CHAR(vbsd.arrival_time, 'DD-Mon-YYYY HH:MI AM') AS arrival_time,
    vbsd.company_name,
    vbsd.base_price,
    (vbsd.capacity - (SELECT COUNT(*) FROM Ticket t WHERE t.schedule_id = vbsd.schedule_id AND t.status = 'Booked')) AS available_seats,
    NVL((
        SELECT LISTAGG(t.seat_number, ', ') WITHIN GROUP (ORDER BY t.seat_number)
        FROM Ticket t
        WHERE t.schedule_id = vbsd.schedule_id AND t.status = 'Booked'
    ), 'None booked yet') AS booked_seats,
    vbsd.platform_no
FROM
    V_BUS_SCHEDULE_DETAILS vbsd
WHERE
    TRUNC(vbsd.departure_time) = TO_DATE('&enter_date_YYYY_MM_DD', 'YYYY-MM-DD')
    AND TRUNC(vbsd.departure_time) >= TRUNC(SYSDATE)
    AND LOWER(vbsd.origin_station) = LOWER('&enter_origin_station')
    AND LOWER(vbsd.destination_station) = LOWER('&enter_destination_station')
    AND (vbsd.capacity - (SELECT COUNT(*) FROM Ticket t WHERE t.schedule_id = vbsd.schedule_id AND t.status = 'Booked')) > 0
ORDER BY
    vbsd.departure_time;

CLEAR COLUMNS;
TTITLE OFF;



